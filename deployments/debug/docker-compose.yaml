name: orca-debug-services
services:
  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard
    ports:
      - '18888:18888' # Dashboard UI
      - '18889:18889' # OTLP gRPC endpoint
    environment:
      - DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true
    volumes:
      - ./aspire-dashboard-data:/data
    restart: unless-stopped
    networks:
      - orca-shared-services
  nutsnode:
    image: nutsfoundation/nuts-node:6.1.2
    ports:
      - '9081:8081' # port exposed for loading test data (create DIDs and VCs, requesting access token)
    volumes:
      - '${orca_dev_base}/nuts/policy/:/nuts/config/policy:ro'
      - '${orca_dev_base}/nuts/discovery/homemonitoring.json:/nuts/discovery/homemonitoring.json:ro'
    environment:
      - NUTS_VERBOSITY=debug
      - NUTS_STRICTMODE=false
      - NUTS_HTTP_INTERNAL_ADDRESS=:8081
      - NUTS_AUTH_CONTRACTVALIDATORS=dummy
      - NUTS_URL=http://nutsnode:8080
      - NUTS_DISCOVERY_DEFINITIONS_DIRECTORY=/nuts/discovery/
      - NUTS_DISCOVERY_SERVER_IDS=dev:HomeMonitoring2024
      - NUTS_DIDMETHODS=web
    networks:
      - orca-shared-services
  nutsnode-init:
    image: badouralix/curl-jq:alpine
    volumes:
      - '${orca_dev_base}/nuts/nutsnode-init.sh:/nutsnode-init.sh:ro'
    depends_on:
      nutsnode:
        condition: service_healthy
    entrypoint:
      [
        'sh',
        '-c',
        "echo 'Waiting for Nuts Node to be ready...'; while ! curl -s -f http://nutsnode:8080/status > /dev/null; do echo 'Waiting for nutsnode to be ready...'; sleep 1; done; echo 'Nutsnode is up and running.' && sh /nutsnode-init.sh",
      ]
    restart: 'no'
    networks:
      - orca-shared-services
  nutsadmin:
    image: 'nutsfoundation/nuts-admin:main'
    environment:
      - NUTS_NODE_ADDRESS=http://nutsnode:8081
    ports:
      - '1405:1305'
    networks:
      - orca-shared-services
  hospital_proxy:
    image: nginx:latest
    depends_on:
      nutsnode:
        condition: service_started
    ports:
      - '8081:8080'
    volumes:
      - '${orca_dev_base}/hospital/config/nginx-proxy.conf:/etc/nginx/conf.d/nginx-proxy.conf:ro'
    networks:
      - orca-shared-services
  fhirstore:
    image: hapiproject/hapi:v7.2.0
    ports:
      - '9090:8080'
    environment:
      - hapi.fhir.fhir_version=R4
      - hapi.fhir.allow_external_references=true
      - hapi.fhir.server_address=http://localhost:9090/fhir
    networks:
      - orca-shared-services
  # The HAPI image has no binaries such as curl, so we use the curl image to perform the health check
  fhirstore-healthcheck:
    image: curlimages/curl:7.87.0
    depends_on:
      - fhirstore
    entrypoint:
      [
        'sh',
        '-c',
        "echo 'Starting fhirstore healthcheck...'; while ! curl -s -f http://fhirstore:8080/fhir/Task > /dev/null; do echo 'Waiting for fhirstore to be ready...'; sleep 5; done; echo 'fhirstore is up and running.'",
      ]
    # Ensure the container exits successfully after the check
    restart: 'no'
    networks:
      - orca-shared-services
  # hospital_ehr moved to VS Code launch configuration
  # Run "Launch Hospital & Clinic Applications" compound configuration in VS Code
  clinic_proxy:
    image: nginx:latest
    depends_on:
      - nutsnode
    ports:
      - '8082:8080'
    networks:
      - orca-shared-services
    volumes:
      - '${orca_dev_base}/clinic/config/nginx-proxy.conf:/etc/nginx/conf.d/nginx-proxy.conf:ro'

networks:
  orca-shared-services:
    driver: bridge
